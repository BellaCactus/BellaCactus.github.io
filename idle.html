<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>idle ‚Ä¢ bella cactus</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" type="image/png" href="twi looking.png" />

  <style>
    :root{
      --bg:#070707;
      --bg2:#0b0b0b;
      --panel: rgba(255,255,255,0.055);
      --panel2: rgba(255,255,255,0.03);
      --border: rgba(255,255,255,0.10);
      --text:#f7f7f7;
      --muted:#b9b9c2;

      --pink:#ff78c8;
      --pink2:#ffb3e6;
      --pink3:#ff4db8;

      --accent: var(--pink);
      --accent2: var(--pink2);
      --accent3: var(--pink3);

      --shadow: 0 20px 70px rgba(0,0,0,0.55);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
    }

    *{box-sizing:border-box;}
    html,body{height:100%;}
    body{
      margin:0;
      background:
        radial-gradient(900px 600px at 15% 12%, color-mix(in srgb, var(--accent) 18%, transparent), transparent 55%),
        radial-gradient(900px 600px at 90% 30%, color-mix(in srgb, var(--accent2) 12%, transparent), transparent 55%),
        radial-gradient(1200px 700px at 40% 95%, color-mix(in srgb, var(--accent3) 9%, transparent), transparent 55%),
        linear-gradient(180deg, var(--bg), var(--bg2));
      color:var(--text);
      font-family: var(--sans);
      overflow:hidden;
    }

    a{color:var(--accent); text-decoration:none;}
    a:hover{text-decoration:underline;}

    .pulseText{
      background: linear-gradient(90deg, #ffffff, var(--accent), #ffffff, var(--accent2), #ffffff);
      background-size: 260% 100%;
      -webkit-background-clip:text;
      background-clip:text;
      color:transparent;
      animation: shimmer 4.8s ease-in-out infinite;
    }
    @keyframes shimmer{
      0%{background-position:0% 50%;}
      50%{background-position:100% 50%;}
      100%{background-position:0% 50%;}
    }

    /* background layer */
    #bg{
      position:fixed;
      inset:0;
      z-index:0;
    }

    /* ui */
    .wrap{
      position:relative;
      z-index:2;
      max-width:980px;
      margin:0 auto;
      padding:22px 16px;
      pointer-events:none; /* screensaver click-through */
      transition: opacity 0.25s ease, transform 0.25s ease;
    }
    .wrap.hiddenUI{
      opacity:0;
      transform: translateY(-8px);
    }

    .panel{
      pointer-events:auto;
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(6px);
    }

    .panelTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 14px;
      border-bottom:1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.18);
    }
    .panelTitle h1{
      margin:0;
      font-size:1.05rem;
      color:var(--accent2);
      letter-spacing:0.3px;
      font-weight:700;
    }
    .small{
      font-size:0.86rem;
      color:var(--muted);
      font-family: var(--mono);
      opacity:0.95;
    }

    .panelInner{
      padding:12px 14px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }

    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .btn{
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.05);
      color:var(--text);
      transition: transform 0.08s ease, background 0.2s ease, border 0.2s ease, opacity 0.2s ease;
      text-decoration:none;
      user-select:none;
      font-family: var(--sans);
      font-size:0.95rem;
      pointer-events:auto;
    }
    .btn:hover{
      text-decoration:none;
      transform: translateY(-1px);
      border-color: color-mix(in srgb, var(--accent) 35%, transparent);
      background: color-mix(in srgb, var(--accent) 10%, transparent);
    }
    .btn:active{ transform: translateY(0); opacity:0.95; }
    .btn .k{ font-family: var(--mono); font-size:0.8rem; color:var(--accent2); }

    .tog{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      color:var(--muted);
      font-family: var(--mono);
      font-size:0.82rem;
      user-select:none;
      pointer-events:auto;
    }
    .tog input{ accent-color: var(--accent); }

    /* corner hint */
    .hint{
      position:fixed;
      left:12px;
      bottom:12px;
      z-index:3;
      color:rgba(255,255,255,0.72);
      font-family: var(--mono);
      font-size:0.82rem;
      background: rgba(0,0,0,0.25);
      border:1px solid rgba(255,255,255,0.10);
      padding:8px 10px;
      border-radius:12px;
      backdrop-filter: blur(6px);
      pointer-events:none;
      max-width:min(520px, 92vw);
      transition: opacity 0.22s ease, transform 0.22s ease;
    }
    .hint.hide{
      opacity:0;
      transform: translateY(8px);
    }

    /* oneko */
    .oneko{
      position:fixed;
      bottom:12px;
      right:12px;
      z-index:4;
      opacity:0.95;
      filter: drop-shadow(0 14px 28px rgba(0,0,0,0.6));
      transform: translateZ(0);
      animation: floaty 3.6s ease-in-out infinite;
      cursor:pointer;
      user-select:none;
      pointer-events:auto;
    }
    @keyframes floaty{
      0%{transform: translateY(0);}
      50%{transform: translateY(-6px);}
      100%{transform: translateY(0);}
    }
    .oneko img{ width:52px; image-rendering:pixelated; display:block; }

    /* evil mode hook (reads same localStorage key as index) */
    body.evil{
      --accent:#ff3b3b;
      --accent2:#ff8b8b;
      --accent3:#ff1f6b;
      filter: saturate(1.05) contrast(1.02);
    }

    /* reduced motion */
    @media (prefers-reduced-motion: reduce){
      .pulseText{ animation:none; }
      .oneko{ animation:none; }
    }
  </style>
</head>

<body>
  <canvas id="bg" aria-hidden="true"></canvas>

  <div class="wrap" id="uiWrap">
    <div class="panel">
      <div class="panelTitle">
        <h1>idle screensaver</h1>
        <div class="small">
          leave me open ‚Ä¢ press <span class="pulseText">space</span> to pause ‚Ä¢ <span class="pulseText">r</span> to reroll
          ‚Ä¢ ui hides if you stop moving
        </div>
      </div>
      <div class="panelInner">
        <div class="btnRow">
          <a class="btn" href="index.html"><span class="k">cd</span> home</a>
          <button class="btn" id="btnPause" type="button"><span class="k">‚è∏</span> pause</button>
          <button class="btn" id="btnReroll" type="button"><span class="k">rng</span> reroll</button>
          <button class="btn" id="btnTheme" type="button"><span class="k">pal</span> theme</button>
        </div>

        <label class="tog" title="less chaos, more calm">
          <input id="chkSoft" type="checkbox" />
          soft mode
        </label>

        <label class="tog" title="fake audio viz if you don't want real audio">
          <input id="chkFakeViz" type="checkbox" checked />
          fake viz
        </label>

        <label class="tog" title="audio needs a click (browser rules). expects a file named idle-bgm.mp3">
          <input id="chkAudio" type="checkbox" />
          audio
        </label>
      </div>
    </div>
  </div>

  <div class="hint" id="hint">
    tip: click anywhere once to arm audio (browser rules) (:3) ‚Ä¢ press <span class="pulseText">esc</span> to go home
  </div>

  <div class="oneko" id="oneko" title="click me" aria-hidden="false">
    <img id="onekoImg" src="oneko.gif" alt="oneko" />
  </div>

  <audio id="bgm" preload="auto" loop>
    <source src="Mobile Suit Woe 0" type="audio/mpeg" />
  </audio>

  <audio id="yeah" preload="auto">
    <source src="lil-jon-yeah.mp3" type="audio/mpeg" />
  </audio>

  <script>
    const $ = (id) => document.getElementById(id);
    const clamp = (n,a,b) => Math.max(a, Math.min(b,n));
    const rand = (a,b) => a + Math.random() * (b - a);
    const pick = (arr) => arr[Math.floor(Math.random() * arr.length)];

    // ---- theme sync with index (THEME_KEY = "bella_theme") ----
    const THEME_KEY = "bella_theme";
    let themeMode = localStorage.getItem(THEME_KEY) || "pink";

    function applyTheme(mode){
      themeMode = mode;
      document.body.classList.toggle("evil", mode === "red");

      const root = document.documentElement.style;
      if (mode === "white"){
        root.setProperty("--accent", "#ffffff");
        root.setProperty("--accent2", "#d6d6dc");
        root.setProperty("--accent3", "#ffffff");
      } else if (mode === "red"){
        root.setProperty("--accent", "#ff3b3b");
        root.setProperty("--accent2", "#ff8b8b");
        root.setProperty("--accent3", "#ff1f6b");
      } else {
        root.setProperty("--accent", "#ff78c8");
        root.setProperty("--accent2", "#ffb3e6");
        root.setProperty("--accent3", "#ff4db8");
      }
      localStorage.setItem(THEME_KEY, mode);
    }

    function cycleTheme(){
      const cur = themeMode;
      const next = cur === "pink" ? "white" : (cur === "white" ? "red" : "pink");
      applyTheme(next);
      flashHint(`theme -> ${next}${next === "red" ? " (evil mode >:3)" : ""}`);
    }

    applyTheme(themeMode);

    // ---- ui auto-hide when idle ----
    const uiWrap = $("uiWrap");
    const hint = $("hint");
    let idleTimer = null;
    let uiHidden = false;
    const HIDE_AFTER_MS = 2800; // ‚Äúfew seconds‚Äù

    function showUI(){
      if (!uiHidden) return;
      uiHidden = false;
      uiWrap.classList.remove("hiddenUI");
      hint.classList.remove("hide");
    }

    function hideUI(){
      if (uiHidden) return;
      uiHidden = true;
      uiWrap.classList.add("hiddenUI");
      hint.classList.add("hide");
    }

    function poke(){
      showUI();
      clearTimeout(idleTimer);
      idleTimer = setTimeout(() => {
        // don‚Äôt hide if user is focused on controls
        const tag = (document.activeElement && document.activeElement.tagName || "").toLowerCase();
        if (tag === "input" || tag === "button" || tag === "select") {
          poke();
          return;
        }
        hideUI();
      }, HIDE_AFTER_MS);
    }

    addEventListener("mousemove", poke, { passive:true });
    addEventListener("mousedown", poke, { passive:true });
    addEventListener("keydown", poke);
    addEventListener("touchstart", poke, { passive:true });
    poke();

    // ---- oneko fallback ----
    const onekoImg = $("onekoImg");
    onekoImg.addEventListener("error", () => {
      if (!onekoImg.dataset.tried) {
        onekoImg.dataset.tried = "1";
        onekoImg.src = "onekogif";
      }
    });

    // ---- canvas setup ----
    const c = $("bg");
    const ctx = c.getContext("2d");

    function fit(){
      const dpr = devicePixelRatio || 1;
      c.width = Math.floor(innerWidth * dpr);
      c.height = Math.floor(innerHeight * dpr);
      c.style.width = innerWidth + "px";
      c.style.height = innerHeight + "px";
      ctx.setTransform(dpr,0,0,dpr,0,0);
    }
    addEventListener("resize", () => { fit(); reroll(); });
    fit();

    // ---- ascii sprites ----
    const critters = [
` /\\_/\\
( o.o )
 > ^ <`,
` (\\_/)
 ( ‚Ä¢_‚Ä¢)
 / >üç™`,
`  /\\_/\\
 (=^.^=)
 (")(")`,
`  /\\_/\\
 ( >.< )
  >üçì<`,
`   /\\_/\\
  ( ‚Ä¢œâ‚Ä¢ )
  /    \\`,
`  /^-----^\\
 V  o o  V
  |  Y  |
   \\ Q /`
    ];

    const whispers = [
      "buffering dreams‚Ä¶",
      "rendering midnight UI‚Ä¶",
      "your tabs are alive",
      "soft reboot of the soul",
      "do not disturb: building",
      "pink glow, low hp",
      "this is fine. (it isn't.)",
      "sleep mode: feral",
      "signal found in the static",
      "press r to reroll reality",
      "press / on index for commands"
    ];

    const stars = [];
    const texts = [];
    const sprites = [];

    let softMode = false;

    function makeStars(){
      stars.length = 0;
      const n = clamp(Math.floor((innerWidth * innerHeight) / 14000), 40, 140);
      for (let i=0;i<n;i++){
        stars.push({
          x: Math.random() * innerWidth,
          y: Math.random() * innerHeight,
          r: rand(0.6, 2.2),
          v: rand(0.08, 0.35),
          p: Math.random() * Math.PI * 2
        });
      }
    }

    function makeTexts(){
      texts.length = 0;
      const n = clamp(Math.floor(innerWidth / 260), 3, 7);
      for (let i=0;i<n;i++){
        texts.push({
          t: pick(whispers),
          x: rand(-200, innerWidth + 200),
          y: rand(80, innerHeight - 80),
          vx: rand(-0.18, -0.05),
          a: rand(0.22, 0.55),
          s: rand(12, 15),
          wob: rand(0.6, 1.6),
          phase: Math.random() * Math.PI * 2
        });
      }
    }

    function makeSprites(){
      sprites.length = 0;
      const n = clamp(Math.floor(innerWidth / 260), 3, 8);
      for (let i=0;i<n;i++){
        const art = pick(critters);
        const lines = art.split("\n");
        sprites.push({
          art,
          lines,
          x: rand(40, innerWidth - 200),
          y: rand(120, innerHeight - 120),
          vx: rand(-0.12, 0.12),
          vy: rand(-0.09, 0.09),
          rot: rand(-0.18, 0.18),
          rvel: rand(-0.0015, 0.0015),
          a: rand(0.35, 0.80),
          s: rand(12, 15),
        });
      }
    }

    // ---- audio + viz (FIXED) ----
    const bgm = $("bgm");
    const chkAudio = $("chkAudio");
    const chkFakeViz = $("chkFakeViz");

    let audioCtx = null, analyser = null, data = null, srcNode = null;
    let audioArmed = false;

    function setupAudio(){
      if (audioCtx) return;
      audioCtx = new (window.AudioContext || window.webkitAudioContext)();
      try{
        srcNode = audioCtx.createMediaElementSource(bgm);
        analyser = audioCtx.createAnalyser();
        analyser.fftSize = 512;
        data = new Uint8Array(analyser.frequencyBinCount);
        srcNode.connect(analyser);
        analyser.connect(audioCtx.destination);
      }catch(e){
        analyser = null; // fallback to fake viz
      }
    }

    async function armAudio(){
      if (audioArmed) return true;
      setupAudio();
      try{
        if (audioCtx && audioCtx.state === "suspended") await audioCtx.resume();
        audioArmed = true;
        flashHint("audio armed (:3)");
        return true;
      }catch(e){
        flashHint("audio blocked. click again maybe.");
        return false;
      }
    }

    async function tryPlayBgm(){
      // must be armed first
      const ok = await armAudio();
      if (!ok) return;
      try{
        await bgm.play();
        flashHint("bgm playing");
      }catch(e){
        flashHint("bgm blocked. click anywhere once, then toggle audio again.");
      }
    }

    // one-time gesture hook: first click arms audio
    document.addEventListener("click", () => { armAudio(); }, { once:false, passive:true });

    // if mp3 missing, show a helpful hint
    bgm.addEventListener("error", () => {
      flashHint("idle-bgm.mp3 not found. add one or keep fake viz.");
      chkAudio.checked = false;
    });

    // viz reader
    function readViz(){
      const forceFake = chkFakeViz.checked || !analyser || bgm.paused;
      const arrLen = 128;
      const arr = new Float32Array(arrLen);

      if (forceFake){
        const t = performance.now() * 0.001;
        for (let i=0;i<arrLen;i++){
          const k = i / (arrLen - 1);
          const wave = Math.sin(t * 2.2 + k * 10.0) * 0.35
                     + Math.sin(t * 1.1 + k * 21.0) * 0.18
                     + Math.sin(t * 0.7 + k * 5.0) * 0.12;
          const drift = (Math.sin(t * 0.35) * 0.12);
          arr[i] = (wave + drift);
        }
        return arr;
      }

      analyser.getByteTimeDomainData(data);
      for (let i=0;i<arrLen;i++){
        const idx = Math.floor(i / (arrLen - 1) * (data.length - 1));
        arr[i] = (data[idx] / 255) * 2 - 1;
      }
      return arr;
    }

    function drawViz(){
      const v = readViz();
      const yMid = innerHeight * (softMode ? 0.72 : 0.68);
      const amp = softMode ? 18 : 30;

      ctx.save();
      ctx.globalAlpha = softMode ? 0.32 : 0.50;
      ctx.lineWidth = 2;
      ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue("--accent").trim() || "#ff78c8";
      ctx.shadowColor = ctx.strokeStyle;
      ctx.shadowBlur = softMode ? 8 : 14;

      ctx.beginPath();
      for (let i=0;i<v.length;i++){
        const x = (i / (v.length - 1)) * innerWidth;
        const y = yMid + v[i] * amp;
        if (i === 0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.stroke();

      ctx.shadowBlur = 0;
      ctx.globalAlpha = 0.16;
      ctx.beginPath();
      ctx.moveTo(0, yMid);
      ctx.lineTo(innerWidth, yMid);
      ctx.strokeStyle = "#ffffff";
      ctx.stroke();

      ctx.restore();
    }

    // ---- reroll + loop ----
    function reroll(){
      makeStars();
      makeTexts();
      makeSprites();
    }
    reroll();

    let paused = false;

    function draw(){
      requestAnimationFrame(draw);
      if (paused) return;

      ctx.clearRect(0,0,innerWidth,innerHeight);

      // stars
      ctx.save();
      for (const s of stars){
        s.p += s.v * 0.02;
        s.y += s.v;
        s.x += Math.sin(s.p) * 0.08;
        if (s.y > innerHeight + 10){
          s.y = -10;
          s.x = Math.random() * innerWidth;
        }
        ctx.globalAlpha = 0.18 + Math.sin(s.p) * 0.08;
        ctx.beginPath();
        ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
        ctx.fillStyle = "#ffffff";
        ctx.fill();
      }
      ctx.restore();

      // whisper text
      ctx.save();
      for (const t of texts){
        t.phase += 0.01 * t.wob;
        t.x += t.vx * (softMode ? 0.55 : 1);
        const yy = t.y + Math.sin(t.phase) * (softMode ? 8 : 14);

        if (t.x < -520){
          t.x = innerWidth + rand(120, 520);
          t.y = rand(80, innerHeight - 80);
          t.t = pick(whispers);
          t.a = rand(0.22, softMode ? 0.40 : 0.55);
        }

        ctx.globalAlpha = t.a;
        ctx.font = `${t.s}px ${getComputedStyle(document.body).getPropertyValue("--mono") || "ui-monospace, monospace"}`;
        ctx.fillStyle = (themeMode === "white")
          ? "rgba(230,230,236,0.92)"
          : "rgba(255,179,230,0.95)";
        ctx.shadowColor = (themeMode === "white")
          ? "rgba(255,255,255,0.25)"
          : "rgba(255,120,200,0.35)";
        ctx.shadowBlur = softMode ? 8 : 14;
        ctx.fillText(t.t, t.x, yy);
      }
      ctx.restore();

      // ascii sprites
      ctx.save();
      for (const s of sprites){
        s.x += s.vx * (softMode ? 0.55 : 1);
        s.y += s.vy * (softMode ? 0.55 : 1);
        s.rot += s.rvel * (softMode ? 0.65 : 1);

        const pad = 40;
        if (s.x < pad || s.x > innerWidth - pad) s.vx *= -1;
        if (s.y < pad || s.y > innerHeight - pad) s.vy *= -1;

        ctx.translate(s.x, s.y);
        ctx.rotate(s.rot);

        ctx.globalAlpha = s.a * (softMode ? 0.75 : 1);
        ctx.font = `${s.s}px ${getComputedStyle(document.body).getPropertyValue("--mono") || "ui-monospace, monospace"}`;
        ctx.textBaseline = "top";

        ctx.shadowBlur = softMode ? 10 : 16;
        ctx.shadowColor = (themeMode === "white")
          ? "rgba(255,255,255,0.18)"
          : "rgba(255,120,200,0.35)";
        ctx.fillStyle = (themeMode === "white")
          ? "rgba(245,245,250,0.85)"
          : "rgba(255,255,255,0.90)";

        for (let i=0;i<s.lines.length;i++){
          ctx.fillText(s.lines[i], 0, i * (s.s + 1));
        }

        ctx.setTransform(1,0,0,1,0,0);
      }
      ctx.restore();

      drawViz();
    }

    // ---- hint helpers ----
    let hintT = null;
    function flashHint(msg){
      hint.textContent = msg;
      hint.classList.remove("hide");
      clearTimeout(hintT);
      hintT = setTimeout(() => {
        // only hide hint if UI is hidden
        if (uiHidden) hint.classList.add("hide");
      }, 2200);
    }

    // ---- controls ----
    function setPaused(v){
      paused = v;
      $("btnPause").innerHTML = paused ? `<span class="k">‚ñ∂</span> resume` : `<span class="k">‚è∏</span> pause`;
      flashHint(paused ? "paused" : "resumed");
    }

    $("btnPause").addEventListener("click", () => setPaused(!paused));
    $("btnReroll").addEventListener("click", () => { reroll(); flashHint("rerolled"); });
    $("btnTheme").addEventListener("click", cycleTheme);
    $("chkSoft").addEventListener("change", (e) => { softMode = !!e.target.checked; });

    chkAudio.addEventListener("change", async (e) => {
      const on = !!e.target.checked;
      if (on){
        await tryPlayBgm();
      } else {
        try{ bgm.pause(); }catch(e2){}
        flashHint("bgm paused");
      }
    });

    // oneko click: lil jon yeah
    $("oneko").addEventListener("click", async () => {
      await armAudio();
      const y = $("yeah");
      y.currentTime = 0;
      y.play().catch(()=>{});
    });

    // keyboard
    addEventListener("keydown", (e) => {
      const k = (e.key || "").toLowerCase();
      if (k === " "){ e.preventDefault(); setPaused(!paused); }
      if (k === "r"){ reroll(); flashHint("rerolled"); }
      if (k === "t"){ cycleTheme(); }
      if (k === "escape"){ location.href = "index.html"; }
    });

    draw();
  </script>
</body>
</html>


name: discord - site updated

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: post to discord webhook
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          SHA: ${{ github.sha }}
          COMMIT_URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          SITE_URL: https://${{ github.repository_owner }}.github.io/
          MSG: ${{ github.event.head_commit.message }}
        run: |
          set -euo pipefail

          if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then
            echo "DISCORD_WEBHOOK_URL secret is missing"
            exit 1
          fi

          payload="$(python - <<'PY'
          import json, os
          repo = os.environ.get("REPO","")
          branch = os.environ.get("BRANCH","")
          actor = os.environ.get("ACTOR","")
          sha = os.environ.get("SHA","")[:7]
          commit_url = os.environ.get("COMMIT_URL","")
          site_url = os.environ.get("SITE_URL","")
          msg = (os.environ.get("MSG","") or "").strip()

          data = {
            "username": "site updated",
            "embeds": [{
              "title": "site updated",
              "url": commit_url,
              "color": 0xff78c8,
              "description": (msg if msg else "(no commit message)"),
              "fields": [
                {"name": "repo", "value": repo, "inline": True},
                {"name": "branch", "value": branch, "inline": True},
                {"name": "by", "value": actor, "inline": True},
                {"name": "commit", "value": f"[{sha}]({commit_url})", "inline": True},
                {"name": "site", "value": site_url, "inline": False},
              ],
              "footer": {"text": "github actions → discord webhook"}
            }]
          }

          print(json.dumps(data, ensure_ascii=False))
          PY
          )"

          # post, and show discord response if it fails (super helpful for debugging)
          http_code="$(curl -sS -o resp.txt -w "%{http_code}" \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK_URL" || true)"

          echo "discord http: $http_code"
          if [ "$http_code" -lt 200 ] || [ "$http_code" -ge 300 ]; then
            echo "discord response:"
            cat resp.txt || true
            exit 1
          fi

          echo "posted ✅"

name: discord - site updated

on:
  push:
    branches: ["main"]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: send discord webhook
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          SITE_URL: https://${{ github.repository_owner }}.github.io/
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "DISCORD_WEBHOOK_URL secret is missing."
            exit 1
          fi

          python3 - << 'PY'
          import json, os, subprocess

          repo = os.environ["REPO"]
          branch = os.environ["BRANCH"]
          actor = os.environ["ACTOR"]
          sha = os.environ["COMMIT_SHA"]
          commit_url = os.environ["COMMIT_URL"]
          site_url = os.environ["SITE_URL"]

          # grab last commit message safely
          msg = subprocess.check_output(["git", "log", "-1", "--pretty=%s"], text=True).strip()
          if not msg:
            msg = "update"

          short = sha[:7]

          payload = {
            "username": "site updates",
            "content": None,
            "embeds": [
              {
                "title": "site updated",
                "url": commit_url,
                "description": f"**{msg}**",
                "fields": [
                  {"name": "repo", "value": repo, "inline": True},
                  {"name": "branch", "value": branch, "inline": True},
                  {"name": "by", "value": actor, "inline": True},
                  {"name": "commit", "value": short, "inline": True},
                  {"name": "site", "value": site_url, "inline": False},
                ],
              }
            ],
          }

          print(json.dumps(payload))
          PY
          # ^ prints json to stdout, but we need it again for curl:
          JSON="$(python3 - << 'PY'
          import json, os, subprocess

          repo = os.environ["REPO"]
          branch = os.environ["BRANCH"]
          actor = os.environ["ACTOR"]
          sha = os.environ["COMMIT_SHA"]
          commit_url = os.environ["COMMIT_URL"]
          site_url = os.environ["SITE_URL"]

          msg = subprocess.check_output(["git", "log", "-1", "--pretty=%s"], text=True).strip()
          if not msg:
            msg = "update"

          short = sha[:7]

          payload = {
            "username": "site updates",
            "content": None,
            "embeds": [
              {
                "title": "site updated",
                "url": commit_url,
                "description": f"**{msg}**",
                "fields": [
                  {"name": "repo", "value": repo, "inline": True},
                  {"name": "branch", "value": branch, "inline": True},
                  {"name": "by", "value": actor, "inline": True},
                  {"name": "commit", "value": short, "inline": True},
                  {"name": "site", "value": site_url, "inline": False},
                ],
              }
            ],
          }

          print(json.dumps(payload))
          PY
          )"

          curl -sS -X POST "$DISCORD_WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$JSON"

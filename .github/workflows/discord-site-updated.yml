name: discord - site updated

on:
  push:
    branches:
      - "**"

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: post to discord webhook
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          COMMIT_SHA: ${{ github.sha }}
          COMMIT_URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          SITE_URL: https://${{ github.repository_owner }}.github.io/
          MSG: ${{ github.event.head_commit.message }}
        run: |
          set -euo pipefail

          if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then
            echo "DISCORD_WEBHOOK_URL secret is missing"
            exit 1
          fi

          # build json safely (no quote/emoji breakage)
          payload="$(python - <<'PY'
import json, os
repo=os.environ["REPO"]
branch=os.environ["BRANCH"]
actor=os.environ["ACTOR"]
sha=os.environ["COMMIT_SHA"][:7]
commit_url=os.environ["COMMIT_URL"]
site=os.environ["SITE_URL"]
msg=os.environ.get("MSG","").strip() or "(no commit message)"

data = {
  "username": "site updated",
  "avatar_url": "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png",
  "embeds": [{
    "title": "site updated",
    "url": commit_url,
    "color": 0xff78c8,
    "description": f"**repo:** `{repo}`\n**branch:** `{branch}`\n**by:** `{actor}`\n**commit:** `{sha}`\n\n**msg:** {msg}",
    "fields": [
      {"name":"site", "value": site, "inline": False}
    ],
    "footer": {"text":"github actions → discord webhook"}
  }]
}

print(json.dumps(data, ensure_ascii=False))
PY
)"

          echo "sending webhook…"
          # curl will fail the step if discord rejects it
          curl -sS -f \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK_URL"

          echo "posted ✅"

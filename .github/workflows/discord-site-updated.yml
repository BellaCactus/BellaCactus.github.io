name: discord - site updated

on:
  push:
    branches: ["main"]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: post embed to discord webhook
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          SHA: ${{ github.sha }}
          MSG: ${{ github.event.head_commit.message }}
        run: |
          if [ -z "$DISCORD_WEBHOOK_URL" ]; then
            echo "missing DISCORD_WEBHOOK_URL secret"
            exit 1
          fi

          python3 - << 'PY'
import os, json, urllib.request

webhook = os.environ["DISCORD_WEBHOOK_URL"]
repo    = os.environ["REPO"]
branch  = os.environ["BRANCH"]
actor   = os.environ["ACTOR"]
sha     = os.environ["SHA"]
msg     = (os.environ.get("MSG") or "").strip()

short_sha  = sha[:7]
commit_url = f"https://github.com/{repo}/commit/{sha}"

# correct pages url for a user site repo like BellaCactus.github.io
owner, name = repo.split("/", 1)
if name.lower() == f"{owner.lower()}.github.io":
  pages_url = f"https://{owner.lower()}.github.io/"
else:
  pages_url = f"https://{owner.lower()}.github.io/{name}/"

if len(msg) > 180:
  msg = msg[:177] + "..."

payload = {
  "username": "site updated",
  "embeds": [{
    "title": "ðŸ–¤ site updated",
    "url": commit_url,
    "description": msg or "(no commit message)",
    "color": 0xFF78C8,
    "fields": [
      {"name":"repo","value": repo, "inline": True},
      {"name":"branch","value": branch, "inline": True},
      {"name":"commit","value": short_sha, "inline": True},
      {"name":"pages","value": pages_url, "inline": False},
      {"name":"pushed by","value": actor, "inline": True},
    ],
    "footer": {"text":"bella cactus â€¢ github actions"}
  }]
}

data = json.dumps(payload).encode("utf-8")
req = urllib.request.Request(webhook, data=data, headers={"Content-Type":"application/json"})
urllib.request.urlopen(req).read()
print("sent âœ…")
PY

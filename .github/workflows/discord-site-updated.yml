name: discord - site updated

on:
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: post to discord webhook
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          BRANCH: ${{ github.ref_name }}
          ACTOR: ${{ github.actor }}
          SHA: ${{ github.sha }}
          COMMIT_URL: ${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}
          SITE_URL: https://${{ github.repository_owner }}.github.io/
          MSG: ${{ github.event.head_commit.message }}
        run: |
          set -euo pipefail

          if [ -z "${DISCORD_WEBHOOK_URL:-}" ]; then
            echo "DISCORD_WEBHOOK_URL secret is missing"
            exit 1
          fi

          # make json safely (handles weird chars/emojis/newlines)
          payload="$(python - <<'PY'
          import json, os
          repo=os.environ["REPO"]
          branch=os.environ["BRANCH"]
          actor=os.environ["ACTOR"]
          sha=os.environ["SHA"][:7]
          commit_url=os.environ["COMMIT_URL"]
          site=os.environ["SITE_URL"]
          msg=(os.environ.get("MSG") or "").strip().splitlines()[0] if os.environ.get("MSG") else ""
          if not msg: msg="(no commit message)"

          data={
            "username":"site updated",
            "embeds":[
              {
                "title":"site updated",
                "color":0xff78c8,
                "fields":[
                  {"name":"repo","value":repo,"inline":True},
                  {"name":"branch","value":branch,"inline":True},
                  {"name":"by","value":actor,"inline":True},
                  {"name":"commit","value":f"[{sha}]({commit_url})","inline":False},
                  {"name":"site","value":site,"inline":False},
                  {"name":"msg","value":msg,"inline":False},
                ],
                "footer":{"text":"github actions → discord webhook"}
              }
            ]
          }
          print(json.dumps(data, ensure_ascii=False))
          PY
          )"

          curl -sS -f \
            -H "Content-Type: application/json" \
            -d "$payload" \
            "$DISCORD_WEBHOOK_URL"

          echo "posted ✅"

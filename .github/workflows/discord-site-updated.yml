name: discord - site updated

on:
  push:
    branches:
      - main
    # if you truly want ANY push, keep as-is.
    # optional anti-spam: uncomment to avoid pinging when you only edit workflows
    # paths-ignore:
    #   - ".github/workflows/**"

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
      - name: post to discord webhook
        env:
          DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
          REPO: ${{ github.repository }}
          ACTOR: ${{ github.actor }}
          BRANCH: ${{ github.ref_name }}
          SHA: ${{ github.sha }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
          OWNER: ${{ github.repository_owner }}
        run: |
          python3 - <<'PY'
          import os, json, urllib.request

          url = os.environ.get("DISCORD_WEBHOOK_URL")
          if not url:
            raise SystemExit("missing DISCORD_WEBHOOK_URL secret")

          repo   = os.environ.get("REPO", "unknown")
          actor  = os.environ.get("ACTOR", "unknown")
          branch = os.environ.get("BRANCH", "unknown")
          sha    = os.environ.get("SHA", "")[:7]
          msg    = os.environ.get("COMMIT_MSG", "(no message)")
          c_url  = os.environ.get("COMMIT_URL", "")
          owner  = os.environ.get("OWNER", "unknown")

          pages_url = f"https://{owner}.github.io/"

          payload = {
            "username": "site bot",
            "embeds": [{
              "title": "site updated",
              "url": c_url or pages_url,
              "description": f"**repo:** {repo}\n**branch:** {branch}\n**by:** {actor}\n**msg:** {msg}",
              "color": 0xff78c8,
              "fields": [
                {"name": "pages", "value": pages_url, "inline": False},
                {"name": "commit", "value": f"`{sha}`", "inline": True},
              ],
            }]
          }

          data = json.dumps(payload).encode("utf-8")
          req = urllib.request.Request(url, data=data, headers={"Content-Type": "application/json"})
          with urllib.request.urlopen(req) as r:
            r.read()

          print("posted âœ…")
          PY
